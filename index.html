<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>방글이를 지켜라</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            text-align: center;
            overflow-x: hidden; /* 좌우 스크롤 방지 */
            font-family: 'Nanum Gothic', sans-serif;
        }

        #gameCanvas {
            width: 93%;
            height: auto;
            max-width: 850px;
            display: block;
            margin: 0.5vh auto 2vh auto;
            padding : 5px;
            touch-action: manipulation;
            aspect-ratio: 17 / 30; /* 850/1500 비율 */
        }

        canvas {
            touch-action: manipulation;
        }

        #startScreen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 5vw 6vw;
            border: 2px solid black;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            font-size: 1rem;
            width: 90%;
            max-width: 350px;
            border-radius: 12px;
            z-index: 2;
            box-sizing: border-box;
            display: flex; /* Flexbox 추가 */
            flex-direction: column; /* 세로 정렬 */
            align-items: center;
        }


        #startScreen input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        #startScreen button {
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            background-color: #00003E;
            color: white;
            border: none;
            border-radius: 8px;
        }
        
        #alertMessage {
             color: red; 
             font-size: 14px; 
             margin-bottom: 10px;
        }

        @media (max-width: 400px) {
            #startScreen {
                width: 90%;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    
    <!-- 1. bang_game.js를 모듈보다 먼저 로드 -->
    <script src="bang_game.js"></script>

    <div id="startScreen">
        <h2>게임 시작 전 정보를 입력해주세요</h2>
        <div id="alertMessage"></div> 
        <input id="departmentInput" placeholder="부서 (예: 감염관리실)" />
        <input id="nameInput" placeholder="이름 (예: 최아름)" />
        <button id="startButton">게임 시작</button>
    </div>

    <!-- 캔버스는 시작 화면과 같은 레벨에 있어야 합니다. -->
    <canvas id="gameCanvas" width="850" height="1500" style="display:none;"></canvas>

<!-- 2. Firebase 관련 함수 (Module Script) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
// import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyB6Pn4hvYaER8GMduVmKKQEHtLimZoKqss",
    authDomain: "banggame-f2ae8.firebaseapp.com",
    projectId: "banggame-f2ae8",
    storageBucket: "banggame-f2ae8.firebasestorage.app",
    messagingSenderId: "494771436388",
    appId: "1:494771436388:web:30af5ee540176b8d501871",
    measurementId: "G-8H40NRTSEK"
};

const app = initializeApp(firebaseConfig);
// const analytics = getAnalytics(app);
const db = getFirestore(app);

// 점수 저장 함수
window.saveScoreToFirebase = async function(playerName, department, score) {
    try {
        await addDoc(collection(db, "rankings"), {
            name: playerName,
            department: department,
            score: score,
            timestamp: new Date()
        });

        console.log("점수 저장 성공!");
    } catch (error) {
        console.error("❌ 저장 실패:", error);
        console.log(`⚠️ 점수 저장 실패. 오류 코드: ${error.message}`);
    }
};

// 랭킹 불러오기 함수
window.loadTopRankings = async function(callback) {
    // 랭킹은 score 내림차순만 사용하고, timestamp는 색인 생성에만 사용합니다.
    const q = query(collection(db, "rankings"), orderBy("score", "desc"), limit(5));
    const querySnapshot = await getDocs(q);
    const rankings = [];
    querySnapshot.forEach((doc) => {
        rankings.push(doc.data());
    });
    callback(rankings);
};

window.playerInfo = null;

</script>

<!-- 3. UI 로직 (Global Script - Module 충돌 방지) -->
<script>
// 게임 시작 핸들러 (글로벌 스코프에 정의하여 bang_game.js와 충돌 방지)
function handleStart() {
    const department = document.getElementById("departmentInput").value.trim();
    const name = document.getElementById("nameInput").value.trim();
    const alertMsg = document.getElementById("alertMessage");

    alertMsg.innerText = ""; 

    if (!department || !name) {
        alertMsg.innerText = "부서와 이름을 모두 입력해주세요.";
        return;
    }

    // window.playerInfo는 Module 스크립트에서 정의되었지만, window 객체로 접근 가능
    window.playerInfo = { department, playerName: name };

    document.getElementById("startScreen").style.display = "none";
    document.getElementById("gameCanvas").style.display = "block";

    // bang_game.js의 startGame()을 바로 호출합니다. (Global Scope 접근)
    if (typeof window.startGame === 'function') {
        window.startGame();
    } else {
        console.error("❌ startGame 함수를 찾을 수 없습니다. bang_game.js 정의를 확인하세요.");
        document.getElementById("startScreen").style.display = "flex";
        document.getElementById("gameCanvas").style.display = "none";
    }
}

// DOMContentLoaded 이벤트 리스너: 문서 구조가 로드되면 버튼에 클릭 이벤트를 연결합니다.
document.addEventListener('DOMContentLoaded', () => {
    const startButton = document.getElementById('startButton');
    if (startButton) {
        startButton.addEventListener('click', handleStart);
    }
});
</script>

</body>
</html>
































